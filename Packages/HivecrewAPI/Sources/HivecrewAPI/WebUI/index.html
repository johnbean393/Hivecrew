<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1c1c1e" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)">
    <title>Hivecrew</title>
    <link rel="stylesheet" href="/web/css/styles.css?v=33">
    <script src="https://cdn.jsdelivr.net/npm/marked@14/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script defer src="/web/js/htmx.min.js"></script>
    <script defer src="/web/js/app.js?v=30"></script>
    <script defer src="/web/js/alpine.min.js"></script>
</head>
<body>
    <div id="app" x-data="hivecrew()" x-init="init()">

        <!-- ============================================================
             Authentication Modal (Device Pairing + API Key fallback)
             ============================================================ -->
        <div class="modal-overlay" x-show="!authenticated" x-cloak>
            <div class="modal auth-modal">
                <div class="modal-header">
                    <h2>Welcome to Hivecrew</h2>
                </div>
                <div class="modal-body">

                    <!-- Device Pairing Mode (default) -->
                    <template x-if="authMode === 'pairing'">
                        <div class="auth-pairing">
                            <template x-if="pairingCode">
                                <div class="pairing-code-container">
                                    <p class="auth-description">Verify this code matches the one shown in the Hivecrew app, then approve it there.</p>
                                    <div class="pairing-code" x-text="pairingCode.slice(0,3) + ' ' + pairingCode.slice(3)"></div>
                                    <div class="pairing-status">
                                        <template x-if="pairingStatus === 'pending'">
                                            <div class="pairing-waiting">
                                                <div class="pairing-dots">
                                                    <span class="pairing-dot"></span>
                                                    <span class="pairing-dot"></span>
                                                    <span class="pairing-dot"></span>
                                                </div>
                                                <span>Waiting for approval...</span>
                                            </div>
                                        </template>
                                        <template x-if="pairingStatus === 'rejected'">
                                            <div class="pairing-rejected">
                                                <span>Pairing was rejected.</span>
                                                <button class="btn btn-secondary btn-small" @click="requestPairingCode()">Try Again</button>
                                            </div>
                                        </template>
                                        <template x-if="pairingStatus === 'expired'">
                                            <div class="pairing-expired">
                                                <span>Code expired.</span>
                                                <button class="btn btn-secondary btn-small" @click="requestPairingCode()">Get New Code</button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            <template x-if="!pairingCode && !pairingLoading">
                                <div class="pairing-init">
                                    <p class="auth-description">Connect this device to your Hivecrew instance.</p>
                                    <button class="btn btn-primary" @click="requestPairingCode()">Get Pairing Code</button>
                                </div>
                            </template>
                            <template x-if="pairingLoading && !pairingCode">
                                <div class="pairing-loading">
                                    <div class="spinner"></div>
                                    <span>Requesting pairing code...</span>
                                </div>
                            </template>
                            <p class="error-text" x-show="authError" x-text="authError"></p>
                            <div class="auth-mode-switch">
                                <button class="btn-link" @click="authMode = 'apikey'">Use API key instead</button>
                            </div>
                        </div>
                    </template>

                    <!-- API Key Mode (fallback) -->
                    <template x-if="authMode === 'apikey'">
                        <div class="auth-apikey">
                            <p class="auth-description">Enter your API key to connect to Hivecrew. You can find this in the Hivecrew app under Settings â†’ API.</p>
                            <div class="form-group">
                                <label for="api-key-input">API Key</label>
                                <input 
                                    type="password" 
                                    id="api-key-input" 
                                    x-model="apiKeyInput" 
                                    placeholder="hc_..."
                                    @keydown.enter="saveApiKey()"
                                >
                            </div>
                            <p class="error-text" x-show="authError" x-text="authError"></p>
                            <div class="modal-footer">
                                <button class="btn btn-primary" @click="saveApiKey()" :disabled="!apiKeyInput">Connect</button>
                            </div>
                            <div class="auth-mode-switch">
                                <button class="btn-link" @click="authMode = 'pairing'; requestPairingCode()">Use device pairing instead</button>
                            </div>
                        </div>
                    </template>

                </div>
            </div>
        </div>

        <!-- ============================================================
             Main App (shown when authenticated)
             ============================================================ -->
        <template x-if="authenticated">
            <div class="app-container">

                <!-- ---- Navigation ---- -->
                <nav class="navbar">
                    <div class="nav-left">
                        <div class="nav-brand">
                            <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"></polygon>
                                <line x1="12" y1="22" x2="12" y2="15.5"></line>
                                <polyline points="22 8.5 12 15.5 2 8.5"></polyline>
                            </svg>
                            <span>Hivecrew</span>
                        </div>
                        <div class="nav-links">
                            <button 
                                class="nav-link" 
                                :class="{ active: view === 'tasks' }" 
                                @click="view = 'tasks'; loadTasks()"
                            >
                                Tasks
                            </button>
                            <button 
                                class="nav-link" 
                                :class="{ active: view === 'scheduled' }" 
                                @click="view = 'scheduled'; loadScheduledTasks()"
                            >
                                Scheduled
                            </button>
                        </div>
                    </div>
                    <div class="nav-actions">
                        <button class="btn btn-primary" @click="openCreateModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            New Task
                        </button>
                        <button class="btn btn-icon" @click="logout()" title="Disconnect">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </nav>

                <!-- ============================================================
                     Tasks View
                     ============================================================ -->
                <main class="main-content" x-show="view === 'tasks'">
                    <div class="content-header">
                        <h1>Tasks</h1>
                        <div class="filter-bar">
                            <input
                                type="text"
                                x-model="searchQuery"
                                placeholder="Search tasks..."
                                class="filter-search"
                            >
                            <select x-model="statusFilter" @change="loadTasks()">
                                <option value="">All Status</option>
                                <option value="queued,waiting_for_vm,running,planning,plan_review">Active</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-icon" @click="loadTasks()" title="Refresh">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" :class="{ 'spin': loading }">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Create Prompt Bar -->
                    <div
                        class="prompt-bar"
                        :class="{ 'prompt-bar-dragover': isDraggingFiles }"
                        @dragover.prevent="isDraggingFiles = true"
                        @dragenter.prevent="isDraggingFiles = true"
                        @dragleave.self="isDraggingFiles = false"
                        @drop.prevent="handlePromptDrop($event)"
                        @click.away="showMentionDropdown = false"
                    >
                        <div class="prompt-input-wrapper">
                            <div
                                class="prompt-input"
                                x-ref="promptTextarea"
                                :contenteditable="!quickCreating"
                                role="textbox"
                                data-placeholder="Describe a task for the agent... (type @ to mention skills, files, or variables)"
                                @keydown="handlePromptKeydown($event)"
                                @keydown.enter.meta.prevent="if (!showMentionDropdown) quickCreateTask()"
                                @keydown.ctrl.enter.prevent="if (!showMentionDropdown) quickCreateTask()"
                                @input="handlePromptInput($event)"
                                @paste.prevent="
                                    const text = ($event.clipboardData || window.clipboardData).getData('text/plain');
                                    document.execCommand('insertText', false, text);
                                "
                            ></div>

                            <!-- @ Mention suggestions dropdown -->
                            <div class="mention-dropdown" x-show="showMentionDropdown" x-cloak x-transition.opacity>
                                <template x-if="mentionSuggestions.some(s => s.type === 'skill')">
                                    <div class="mention-section-header">Skills</div>
                                </template>
                                <template x-for="(item, idx) in mentionSuggestions.filter(s => s.type === 'skill')" :key="'skill-' + item.name">
                                    <button
                                        type="button"
                                        class="mention-item"
                                        :class="{ selected: mentionSelectedIndex === mentionSuggestions.indexOf(item) }"
                                        @mousedown.prevent="selectMention(item)"
                                        @mouseenter="mentionSelectedIndex = mentionSuggestions.indexOf(item)"
                                    >
                                        <span class="mention-item-icon mention-icon-skill">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <path d="M12 2l2.4 7.4H22l-6 4.6 2.3 7L12 16.4 5.7 21l2.3-7L2 9.4h7.6z"></path>
                                            </svg>
                                        </span>
                                        <span class="mention-item-text">
                                            <span class="mention-item-name" x-text="item.name"></span>
                                            <span class="mention-item-desc" x-text="item.description"></span>
                                        </span>
                                    </button>
                                </template>
                                <template x-if="mentionSuggestions.some(s => s.type === 'file')">
                                    <div class="mention-section-header">Attachments</div>
                                </template>
                                <template x-for="(item, idx) in mentionSuggestions.filter(s => s.type === 'file')" :key="'file-' + item.name">
                                    <button
                                        type="button"
                                        class="mention-item"
                                        :class="{ selected: mentionSelectedIndex === mentionSuggestions.indexOf(item) }"
                                        @mousedown.prevent="selectMention(item)"
                                        @mouseenter="mentionSelectedIndex = mentionSuggestions.indexOf(item)"
                                    >
                                        <span class="mention-item-icon mention-icon-file">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                        </span>
                                        <span class="mention-item-text">
                                            <span class="mention-item-name" x-text="item.name"></span>
                                            <span class="mention-item-desc" x-text="item.description"></span>
                                        </span>
                                    </button>
                                </template>
                                <template x-if="mentionSuggestions.some(s => s.type === 'envvar')">
                                    <div class="mention-section-header">Environment Variables</div>
                                </template>
                                <template x-for="(item, idx) in mentionSuggestions.filter(s => s.type === 'envvar')" :key="'envvar-' + item.name">
                                    <button
                                        type="button"
                                        class="mention-item"
                                        :class="{ selected: mentionSelectedIndex === mentionSuggestions.indexOf(item) }"
                                        @mousedown.prevent="selectMention(item)"
                                        @mouseenter="mentionSelectedIndex = mentionSuggestions.indexOf(item)"
                                    >
                                        <span class="mention-item-icon mention-icon-envvar">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <polyline points="4 17 10 11 4 5"></polyline>
                                                <line x1="12" y1="19" x2="20" y2="19"></line>
                                            </svg>
                                        </span>
                                        <span class="mention-item-text">
                                            <span class="mention-item-name" x-text="item.name"></span>
                                            <span class="mention-item-desc" x-text="item.description"></span>
                                        </span>
                                    </button>
                                </template>
                                <template x-if="mentionSuggestions.some(s => s.type === 'injectedfile')">
                                    <div class="mention-section-header">Injected Files</div>
                                </template>
                                <template x-for="(item, idx) in mentionSuggestions.filter(s => s.type === 'injectedfile')" :key="'injfile-' + item.name">
                                    <button
                                        type="button"
                                        class="mention-item"
                                        :class="{ selected: mentionSelectedIndex === mentionSuggestions.indexOf(item) }"
                                        @mousedown.prevent="selectMention(item)"
                                        @mouseenter="mentionSelectedIndex = mentionSuggestions.indexOf(item)"
                                    >
                                        <span class="mention-item-icon mention-icon-injectedfile">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                            </svg>
                                        </span>
                                        <span class="mention-item-text">
                                            <span class="mention-item-name" x-text="item.name"></span>
                                            <span class="mention-item-desc" x-text="item.description"></span>
                                        </span>
                                    </button>
                                </template>
                                <template x-if="mentionSuggestions.length === 0">
                                    <div class="mention-empty">No matching skills, files, or variables</div>
                                </template>
                            </div>
                        </div>

                        <!-- Attached file chips -->
                        <template x-if="quickFiles.length > 0">
                            <div class="prompt-chips">
                                <template x-for="(file, i) in quickFiles" :key="i">
                                    <span class="prompt-file-chip">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        <span x-text="file.name"></span>
                                        <button type="button" @click="removeQuickFile(i)" title="Remove">&times;</button>
                                    </span>
                                </template>
                            </div>
                        </template>

                        <!-- Toolbar -->
                        <div class="prompt-toolbar">
                            <!-- Attach files -->
                            <label class="prompt-toolbar-btn" title="Attach files">
                                <input type="file" multiple @change="handleQuickFileSelect($event)" class="prompt-file-input">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                </svg>
                            </label>

                            <!-- Model selector -->
                            <div class="prompt-model-select" @click.away="modelDropdownOpen = false">
                                <button
                                    type="button"
                                    class="prompt-model-trigger"
                                    @click="modelDropdownOpen = !modelDropdownOpen; if(modelDropdownOpen) $nextTick(() => $refs.modelSearch?.focus())"
                                >
                                    <span class="prompt-model-value" x-text="quickModelId || 'Select model...'"></span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <div class="prompt-model-dropdown" x-show="modelDropdownOpen" x-cloak x-transition.opacity>
                                    <input
                                        type="text"
                                        class="prompt-model-search"
                                        x-ref="modelSearch"
                                        x-model="modelSearchQuery"
                                        placeholder="Search or enter model ID..."
                                        @keydown.enter.prevent="selectCustomModel()"
                                        @keydown.escape.prevent="modelDropdownOpen = false"
                                    >
                                    <div class="prompt-model-options">
                                        <template x-for="model in filteredModels" :key="model.id">
                                            <button
                                                type="button"
                                                class="prompt-model-option"
                                                :class="{ selected: quickModelId === model.id }"
                                                @click="selectModel(model.id)"
                                            >
                                                <span class="prompt-model-option-name" x-text="model.name"></span>
                                                <span class="prompt-model-option-id" x-text="model.id"></span>
                                            </button>
                                        </template>
                                        <template x-if="modelSearchQuery.trim() && filteredModels.length === 0">
                                            <button type="button" class="prompt-model-option" @click="selectCustomModel()">
                                                <span class="prompt-model-option-name">Use custom model</span>
                                                <span class="prompt-model-option-id" x-text="modelSearchQuery.trim()"></span>
                                            </button>
                                        </template>
                                        <template x-if="availableModels.length === 0 && !modelSearchQuery.trim()">
                                            <div class="prompt-model-empty">Type a model ID and press Enter</div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Direct / Plan mode toggle -->
                            <div class="prompt-mode-toggle">
                                <button
                                    type="button"
                                    class="prompt-mode-btn"
                                    :class="{ active: !quickPlanFirst }"
                                    @click="setQuickMode(false)"
                                >Direct</button>
                                <button
                                    type="button"
                                    class="prompt-mode-btn"
                                    :class="{ active: quickPlanFirst }"
                                    @click="setQuickMode(true)"
                                >Plan</button>
                            </div>

                            <!-- Run button -->
                            <button
                                class="btn btn-primary btn-icon-only"
                                @click="quickCreateTask()"
                                :disabled="quickCreating || !quickTaskDescription.trim()"
                                title="Run task"
                            >
                                <span x-show="quickCreating" x-cloak class="spinner-small"></span>
                                <svg x-show="!quickCreating" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="loading-state" x-show="loading && tasks.length === 0">
                        <div class="spinner"></div>
                        <p>Loading tasks...</p>
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state" x-show="!loading && filteredTasks.length === 0">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3>No tasks yet</h3>
                        <p>Create your first task to get started</p>
                        <button class="btn btn-primary" @click="openCreateModal()">Create Task</button>
                    </div>

                    <!-- Task List -->
                    <div class="task-list" x-show="filteredTasks.length > 0">
                        <template x-for="task in filteredTasks" :key="task.id">
                            <div class="task-card" @click="openTaskDetail(task)">
                                <div class="task-header">
                                    <template x-if="task.status === 'completed' && task.wasSuccessful === true">
                                        <span class="task-status status-completed">Verified</span>
                                    </template>
                                    <template x-if="task.status === 'completed' && task.wasSuccessful === false">
                                        <span class="task-status status-failed">Incomplete</span>
                                    </template>
                                    <template x-if="!(task.status === 'completed' && (task.wasSuccessful === true || task.wasSuccessful === false))">
                                        <span class="task-status" :class="'status-' + task.status" x-text="formatStatus(task.status)"></span>
                                    </template>
                                    <span class="task-time" x-text="formatDate(task.createdAt)"></span>
                                </div>
                                <h3 class="task-title" x-text="task.title"></h3>
                                <div class="task-meta">
                                    <span class="task-model" x-text="task.modelId"></span>
                                    <span class="task-provider" x-text="task.providerName"></span>
                                    <template x-if="['running', 'planning', 'queued', 'waiting_for_vm'].includes(task.status)">
                                        <span class="task-elapsed" x-text="formatElapsed(task.startedAt || task.createdAt)"></span>
                                    </template>
                                    <template x-if="task.duration && ['completed', 'failed', 'timed_out', 'max_iterations'].includes(task.status)">
                                        <span class="task-duration" x-text="formatDuration(task.duration)"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </main>

                <!-- ============================================================
                     Scheduled Tasks View
                     ============================================================ -->
                <main class="main-content" x-show="view === 'scheduled'">
                    <div class="content-header">
                        <h1>Scheduled Tasks</h1>
                        <div class="filter-bar">
                            <button class="btn btn-icon" @click="loadScheduledTasks()" title="Refresh">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" :class="{ 'spin': loading }">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="loading-state" x-show="loading && scheduledTasks.length === 0">
                        <div class="spinner"></div>
                        <p>Loading scheduled tasks...</p>
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state" x-show="!loading && scheduledTasks.length === 0">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <h3>No scheduled tasks</h3>
                        <p>Schedule a task to run at a specific time</p>
                        <button class="btn btn-primary" @click="openScheduleModal()">Schedule Task</button>
                    </div>

                    <!-- Scheduled Task List -->
                    <div class="task-list" x-show="scheduledTasks.length > 0">
                        <template x-for="schedule in scheduledTasks" :key="schedule.id">
                            <div class="task-card scheduled-card" :class="{ 'disabled-card': !schedule.isEnabled }" @click="openScheduleDetail(schedule)">
                                <div class="task-header">
                                    <span class="task-status" :class="schedule.isEnabled ? 'status-scheduled' : 'status-cancelled'">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        <span x-text="schedule.isEnabled ? 'Scheduled' : 'Disabled'"></span>
                                    </span>
                                    <span class="task-time" x-text="formatScheduledTime(schedule)"></span>
                                </div>
                                <h3 class="task-title" x-text="schedule.title"></h3>
                                <div class="task-meta">
                                    <span class="task-model" x-text="schedule.modelId"></span>
                                    <template x-if="schedule.recurrence">
                                        <span class="task-recurrence">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <polyline points="17 1 21 5 17 9"></polyline>
                                                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                                                <polyline points="7 23 3 19 7 15"></polyline>
                                                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                                            </svg>
                                            Recurring
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </main>

                <!-- ============================================================
                     Create / Schedule Task Modal
                     ============================================================ -->
                <div class="modal-overlay" x-show="showCreateModal" x-cloak @click.self="closeCreateModal()">
                    <div class="modal create-modal">
                        <div class="modal-header">
                            <h2 x-text="isScheduling ? 'Schedule Task' : 'New Task'"></h2>
                            <button class="btn btn-icon" @click="closeCreateModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Title (for scheduling) -->
                            <template x-if="isScheduling">
                                <div class="form-group">
                                    <label for="task-title">Title</label>
                                    <input 
                                        type="text" 
                                        id="task-title" 
                                        x-model="newTask.title" 
                                        placeholder="Give this scheduled task a name..."
                                    >
                                </div>
                            </template>

                            <!-- Task Description -->
                            <div class="form-group">
                                <label for="task-description">What should the agent do?</label>
                                <textarea 
                                    id="task-description" 
                                    x-model="newTask.description" 
                                    placeholder="Describe the task for the agent..."
                                    rows="4"
                                ></textarea>
                            </div>

                            <!-- Provider Selection -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="provider-select">Provider</label>
                                    <select id="provider-select" x-model="newTask.providerId" @change="saveProviderSelection()">
                                        <option value="">Select provider...</option>
                                        <template x-for="provider in providers" :key="provider.id">
                                            <option :value="provider.id" x-text="provider.displayName"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="model-input">Model</label>
                                    <input 
                                        type="text" 
                                        id="model-input"
                                        x-model="newTask.modelId"
                                        placeholder="e.g. anthropic/claude-sonnet-4"
                                        @input="saveModelSelection()"
                                    >
                                </div>
                            </div>

                            <!-- File Attachments -->
                            <div class="form-group file-upload-group">
                                <label for="task-files-input">Attach Files (optional)</label>
                                <div class="file-input-wrapper">
                                    <input 
                                        type="file" 
                                        id="task-files-input" 
                                        multiple 
                                        @change="handleFileSelect($event)"
                                        class="file-input"
                                    >
                                    <div class="file-input-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                        </svg>
                                        <span>Choose files or drag and drop</span>
                                    </div>
                                </div>
                                <!-- Selected files list -->
                                <template x-if="newTask.files.length > 0">
                                    <div class="selected-files">
                                        <template x-for="(file, index) in newTask.files" :key="index">
                                            <div class="selected-file">
                                                <span class="file-name" x-text="file.name"></span>
                                                <span class="file-size" x-text="formatFileSize(file.size)"></span>
                                                <button type="button" class="file-remove" @click="removeFile(index)" title="Remove file">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Plan First Toggle (non-scheduled tasks only) -->
                            <template x-if="!isScheduling">
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input 
                                            type="checkbox" 
                                            x-model="newTask.planFirst"
                                        >
                                        <span class="checkbox-toggle"></span>
                                        <span class="checkbox-text">Plan first</span>
                                    </label>
                                    <p class="form-hint">Generate a plan for review before executing the task</p>
                                </div>
                            </template>

                            <!-- Schedule Options (when scheduling) -->
                            <template x-if="isScheduling">
                                <div class="schedule-options">
                                    <div class="form-group">
                                        <label>Schedule Type</label>
                                        <div class="toggle-group">
                                            <button 
                                                type="button"
                                                class="toggle-btn" 
                                                :class="{ active: !newTask.isRecurring }"
                                                @click="newTask.isRecurring = false"
                                            >One-time</button>
                                            <button 
                                                type="button"
                                                class="toggle-btn" 
                                                :class="{ active: newTask.isRecurring }"
                                                @click="newTask.isRecurring = true"
                                            >Recurring</button>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="schedule-date">Date</label>
                                            <input type="date" id="schedule-date" x-model="newTask.scheduleDate">
                                        </div>
                                        <div class="form-group">
                                            <label for="schedule-time">Time</label>
                                            <input type="time" id="schedule-time" x-model="newTask.scheduleTime">
                                        </div>
                                    </div>

                                    <!-- Recurrence Options -->
                                    <template x-if="newTask.isRecurring">
                                        <div class="recurrence-options">
                                            <div class="form-group">
                                                <label for="recurrence-type">Repeat</label>
                                                <select id="recurrence-type" x-model="newTask.recurrenceType">
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>

                                            <!-- Days of Week (for weekly) - 1=Sunday, 2=Monday, etc. -->
                                            <template x-if="newTask.recurrenceType === 'weekly'">
                                                <div class="form-group">
                                                    <label>Days of Week</label>
                                                    <div class="day-selector">
                                                        <template x-for="(day, index) in [{n:'S',v:1},{n:'M',v:2},{n:'T',v:3},{n:'W',v:4},{n:'T',v:5},{n:'F',v:6},{n:'S',v:7}]" :key="day.v">
                                                            <button 
                                                                type="button"
                                                                class="day-btn" 
                                                                :class="{ active: newTask.daysOfWeek.includes(day.v) }"
                                                                @click="toggleDay(day.v)"
                                                                x-text="day.n"
                                                            ></button>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Day of Month (for monthly) -->
                                            <template x-if="newTask.recurrenceType === 'monthly'">
                                                <div class="form-group">
                                                    <label for="day-of-month">Day of Month</label>
                                                    <input type="number" id="day-of-month" x-model="newTask.dayOfMonth" min="1" max="31">
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <p class="error-text" x-show="createError" x-text="createError"></p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="closeCreateModal()">Cancel</button>
                            <template x-if="!isScheduling">
                                <button class="btn btn-secondary" @click="isScheduling = true">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    Schedule Instead
                                </button>
                            </template>
                            <button 
                                type="button"
                                class="btn btn-primary" 
                                @click="createTask()" 
                                @touchend.prevent="createTask()"
                                :disabled="creating"
                            >
                                <span x-show="creating" x-cloak class="spinner-small"></span>
                                <span x-text="isScheduling ? 'Schedule' : 'Create Task'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ============================================================
                     Task Detail Modal
                     ============================================================ -->
                <div class="modal-overlay" x-show="selectedTask" x-cloak @click.self="closeTaskDetail()">
                    <div class="modal detail-modal" :class="{ 'is-active': isActiveStatus(selectedTask?.status), 'is-plan-review': isPlanReviewStatus(selectedTask?.status) }" x-show="selectedTask">
                        <div class="modal-header">
                            <div class="detail-header-content">
                                <span class="task-status" :class="'status-' + selectedTask?.status" x-text="formatStatus(selectedTask?.status)"></span>
                                <h2 x-text="selectedTask?.title"></h2>
                            </div>
                            <button class="btn btn-icon" @click="closeTaskDetail()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body" x-show="selectedTask">

                            <!-- ========== PLAN REVIEW: Full-width plan layout ========== -->
                            <template x-if="isPlanReviewStatus(selectedTask?.status)">
                                <div class="plan-review-layout">
                                    <!-- Planning indicator -->
                                    <template x-if="selectedTask?.status === 'planning'">
                                        <div class="plan-generating">
                                            <div class="spinner"></div>
                                            <span>Generating plan...</span>
                                        </div>
                                    </template>

                                    <!-- Rendered plan -->
                                    <template x-if="selectedTask?.planMarkdown">
                                        <div class="plan-review-body">
                                            <div class="plan-review-header">
                                                <div class="plan-review-title">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                        <polyline points="14 2 14 8 20 8"></polyline>
                                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                                        <polyline points="10 9 9 9 8 9"></polyline>
                                                    </svg>
                                                    <h3>PLAN</h3>
                                                </div>
                                                <template x-if="selectedTask?.status === 'plan_review' && !planEditing">
                                                    <button class="btn btn-icon btn-small" @click="planEditing = true; editedPlanMarkdown = selectedTask?.planMarkdown || ''" title="Edit plan">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                        </svg>
                                                    </button>
                                                </template>
                                            </div>
                                            <template x-if="!planEditing">
                                                <div class="plan-rendered" x-html="renderMarkdown(selectedTask?.planMarkdown)"></div>
                                            </template>
                                            <template x-if="planEditing">
                                                <div class="plan-edit">
                                                    <textarea class="plan-textarea" x-model="editedPlanMarkdown" rows="16"></textarea>
                                                    <div class="plan-edit-actions">
                                                        <button class="btn btn-secondary btn-small" @click="planEditing = false">Cancel</button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Task description (compact, below plan) -->
                                    <div class="detail-section plan-review-description">
                                        <p class="detail-description" x-text="selectedTask?.description"></p>
                                    </div>
                                </div>
                            </template>

                            <!-- ========== ACTIVE TASK: Two-column layout ========== -->
                            <template x-if="isActiveStatus(selectedTask?.status)">
                                <div class="detail-body-columns">
                                    <!-- Left column: Screenshot + Banners -->
                                    <div class="detail-left-column">
                                        <!-- Live Screenshot -->
                                        <template x-if="screenshotUrl">
                                            <div class="screenshot-section">
                                                <img :src="screenshotUrl" class="task-screenshot" alt="VM Screenshot">
                                            </div>
                                        </template>
                                        <template x-if="!screenshotUrl">
                                            <div class="screenshot-placeholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="32" height="32">
                                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                                </svg>
                                                <span>Waiting for screenshot...</span>
                                            </div>
                                        </template>

                                        <!-- User Prompt Box -->
                                        <div class="user-prompt-box">
                                            <p class="user-prompt-text" x-text="selectedTask?.description"></p>
                                            <template x-if="selectedTask?.inputFiles?.length > 0">
                                                <div class="user-prompt-attachments">
                                                    <template x-for="file in selectedTask?.inputFiles" :key="file.name">
                                                        <span class="prompt-file-chip">
                                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                            </svg>
                                                            <span x-text="file.name"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Pending Agent Question Banner -->
                                        <template x-if="selectedTask?.pendingQuestion">
                                            <div class="question-banner">
                                                <div class="question-banner-header">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                                    </svg>
                                                    <span class="question-banner-label">Agent Question</span>
                                                </div>
                                                <p class="question-banner-text" x-text="selectedTask.pendingQuestion.question"></p>
                                                <template x-if="selectedTask.pendingQuestion.suggestedAnswers?.length > 0">
                                                    <div class="question-banner-suggestions">
                                                        <template x-for="(suggestion, i) in selectedTask.pendingQuestion.suggestedAnswers" :key="i">
                                                            <button class="btn btn-secondary btn-small" @click="submitAnswer(suggestion)" :disabled="actionLoading" x-text="suggestion"></button>
                                                        </template>
                                                    </div>
                                                </template>
                                                <div class="question-banner-input">
                                                    <input type="text" class="action-bar-input" x-model="answerText" placeholder="Type your answer..." @keydown.enter="submitAnswer()" :disabled="actionLoading">
                                                    <button class="btn btn-primary" @click="submitAnswer()" :disabled="actionLoading || !answerText.trim()">
                                                        <span x-text="actionLoading ? 'Sending...' : 'Answer'"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Pending Permission Request Banner -->
                                        <template x-if="selectedTask?.pendingPermission">
                                            <div class="permission-banner">
                                                <div class="permission-banner-header">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                                    </svg>
                                                    <span class="permission-banner-label">Permission Required</span>
                                                </div>
                                                <p class="permission-banner-tool" x-text="selectedTask.pendingPermission.toolName"></p>
                                                <p class="permission-banner-details" x-text="selectedTask.pendingPermission.details"></p>
                                                <div class="permission-banner-actions">
                                                    <button class="btn btn-primary" @click="approvePermission()" :disabled="actionLoading">Approve</button>
                                                    <button class="btn btn-danger" @click="denyPermission()" :disabled="actionLoading">Deny</button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Right column: Event Log -->
                                    <div class="event-log">
                                        <template x-if="taskEvents.length === 0">
                                            <div class="event-log-empty">
                                                <div class="spinner"></div>
                                                <span>Connecting to event stream...</span>
                                            </div>
                                        </template>
                                        <template x-for="(evt, idx) in taskEvents" :key="idx">
                                            <div class="event-entry" :class="'event-type-' + (evt.data?.activityType || evt.type)">
                                                <div class="event-entry-icon">
                                                    <!-- Tool call -->
                                                    <template x-if="evt.data?.activityType === 'tool_call'">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                                        </svg>
                                                    </template>
                                                    <!-- Tool result -->
                                                    <template x-if="evt.data?.activityType === 'tool_result'">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <polyline points="20 6 9 17 4 12"></polyline>
                                                        </svg>
                                                    </template>
                                                    <!-- LLM request/response -->
                                                    <template x-if="evt.data?.activityType === 'llm_request' || evt.data?.activityType === 'llm_response'">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                        </svg>
                                                    </template>
                                                    <!-- Screenshot/observation -->
                                                    <template x-if="evt.data?.activityType === 'observation'">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                                            <line x1="8" y1="21" x2="16" y2="21"></line>
                                                            <line x1="12" y1="17" x2="12" y2="21"></line>
                                                        </svg>
                                                    </template>
                                                    <!-- Error -->
                                                    <template x-if="evt.data?.activityType === 'error'">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                                        </svg>
                                                    </template>
                                                    <!-- Info / status / other -->
                                                    <template x-if="!['tool_call','tool_result','llm_request','llm_response','observation','error'].includes(evt.data?.activityType)">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <line x1="12" y1="16" x2="12" y2="12"></line>
                                                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                                        </svg>
                                                    </template>
                                                </div>
                                                <div class="event-entry-content">
                                                    <span class="event-entry-summary" x-text="evt.data?.summary || evt.type"></span>
                                                    <template x-if="evt.data?.details">
                                                        <p class="event-entry-details" x-text="evt.data.details"></p>
                                                    </template>
                                                    <template x-if="evt.data?.reasoning">
                                                        <div class="event-entry-reasoning" x-text="evt.data.reasoning"></div>
                                                    </template>
                                                </div>
                                                <span class="event-entry-time" x-text="formatEventTime(evt.timestamp)"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- ========== INACTIVE TASK: Single-column layout ========== -->
                            <template x-if="!isActiveStatus(selectedTask?.status) && !isPlanReviewStatus(selectedTask?.status)">
                                <div>
                                    <!-- Task Description -->
                                    <div class="detail-section">
                                        <h4>Description</h4>
                                        <p class="detail-description" x-text="selectedTask?.description"></p>
                                    </div>

                                    <!-- Plan Section (rendered markdown) -->
                                    <template x-if="selectedTask?.planMarkdown">
                                        <div class="detail-section plan-section">
                                            <div class="plan-header">
                                                <h4>Plan</h4>
                                            </div>
                                            <div class="plan-rendered" x-html="renderMarkdown(selectedTask?.planMarkdown)"></div>
                                        </div>
                                    </template>

                                    <!-- Task Info Grid -->
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Provider</span>
                                            <span class="detail-value" x-text="selectedTask?.providerName"></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Model</span>
                                            <span class="detail-value" x-text="selectedTask?.modelId"></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Created</span>
                                            <span class="detail-value" x-text="formatDateTime(selectedTask?.createdAt)"></span>
                                        </div>
                                        <template x-if="selectedTask?.startedAt">
                                            <div class="detail-item">
                                                <span class="detail-label">Started</span>
                                                <span class="detail-value" x-text="formatDateTime(selectedTask?.startedAt)"></span>
                                            </div>
                                        </template>
                                        <template x-if="selectedTask?.completedAt">
                                            <div class="detail-item">
                                                <span class="detail-label">Completed</span>
                                                <span class="detail-value" x-text="formatDateTime(selectedTask?.completedAt)"></span>
                                            </div>
                                        </template>
                                        <template x-if="selectedTask?.duration">
                                            <div class="detail-item">
                                                <span class="detail-label">Duration</span>
                                                <span class="detail-value" x-text="formatDuration(selectedTask?.duration)"></span>
                                            </div>
                                        </template>
                                        <template x-if="selectedTask?.stepCount">
                                            <div class="detail-item">
                                                <span class="detail-label">Steps</span>
                                                <span class="detail-value" x-text="selectedTask?.stepCount"></span>
                                            </div>
                                        </template>
                                        <template x-if="selectedTask?.tokenUsage">
                                            <div class="detail-item">
                                                <span class="detail-label">Tokens</span>
                                                <span class="detail-value" x-text="selectedTask?.tokenUsage?.total?.toLocaleString()"></span>
                                            </div>
                                        </template>
                                        <template x-if="selectedTask?.wasSuccessful !== null && selectedTask?.wasSuccessful !== undefined">
                                            <div class="detail-item">
                                                <span class="detail-label">Verification</span>
                                                <span class="detail-value" :style="selectedTask?.wasSuccessful ? 'color: var(--status-completed)' : 'color: var(--status-failed)'" x-text="selectedTask?.wasSuccessful ? 'Verified Complete' : 'Incomplete'"></span>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Result Summary -->
                                    <template x-if="selectedTask?.resultSummary">
                                        <div class="detail-section">
                                            <h4>Result</h4>
                                            <p class="detail-result" x-text="selectedTask?.resultSummary"></p>
                                        </div>
                                    </template>

                                    <!-- Error Message -->
                                    <template x-if="selectedTask?.errorMessage">
                                        <div class="detail-section error-section">
                                            <h4>Error</h4>
                                            <p class="detail-error" x-text="selectedTask?.errorMessage"></p>
                                        </div>
                                    </template>

                                    <!-- Output Files -->
                                    <template x-if="selectedTask?.outputFiles?.length > 0">
                                        <div class="detail-section">
                                            <h4>Output Files</h4>
                                            <div class="file-list">
                                                <template x-for="file in selectedTask?.outputFiles" :key="file.name">
                                                    <div class="file-item downloadable" @click="downloadFile(selectedTask?.id, file.name)">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                            <polyline points="14 2 14 8 20 8"></polyline>
                                                        </svg>
                                                        <span class="file-name" x-text="file.name"></span>
                                                        <span class="file-size" x-text="formatFileSize(file.size)"></span>
                                                        <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                            <polyline points="7 10 12 15 17 10"></polyline>
                                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                                        </svg>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Input Files -->
                                    <template x-if="selectedTask?.inputFiles?.length > 0">
                                        <div class="detail-section">
                                            <h4>Input Files</h4>
                                            <div class="file-list">
                                                <template x-for="file in selectedTask?.inputFiles" :key="file.name">
                                                    <div class="file-item downloadable" @click="downloadFile(selectedTask?.id, file.name, true)">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                            <polyline points="14 2 14 8 20 8"></polyline>
                                                        </svg>
                                                        <span class="file-name" x-text="file.name"></span>
                                                        <span class="file-size" x-text="formatFileSize(file.size)"></span>
                                                        <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                            <polyline points="7 10 12 15 17 10"></polyline>
                                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                                        </svg>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                        <div class="modal-footer" x-show="selectedTask">
                            <!-- Actions based on status -->
                            <template x-if="selectedTask?.status === 'running'">
                                <div class="action-buttons action-bar-full">
                                    <div class="action-bar-row">
                                        <input
                                            type="text"
                                            class="action-bar-input"
                                            x-model="instructionsText"
                                            placeholder="Send instructions to agent..."
                                            @keydown.enter="sendInstructions()"
                                            :disabled="actionLoading"
                                        >
                                        <button class="btn btn-primary btn-icon-only" @click="sendInstructions()" :disabled="actionLoading || !instructionsText.trim()" title="Send">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                            </svg>
                                        </button>
                                        <button class="btn btn-secondary btn-icon-only" @click="pauseTask()" :disabled="actionLoading" title="Pause">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <rect x="6" y="4" width="4" height="16"></rect>
                                                <rect x="14" y="4" width="4" height="16"></rect>
                                            </svg>
                                        </button>
                                        <button class="btn btn-danger btn-icon-only" @click="cancelTask()" :disabled="actionLoading" title="Cancel">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <template x-if="selectedTask?.status === 'paused'">
                                <div class="action-buttons">
                                    <button class="btn btn-primary" @click="resumeTask()" :disabled="actionLoading">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                        Resume
                                    </button>
                                    <button class="btn btn-danger btn-icon-only" @click="cancelTask()" :disabled="actionLoading" title="Cancel">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="selectedTask?.status === 'queued' || selectedTask?.status === 'waiting_for_vm'">
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-icon-only" @click="cancelTask()" :disabled="actionLoading" title="Cancel">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="selectedTask?.status === 'plan_review'">
                                <div class="action-buttons">
                                    <template x-if="!planEditing">
                                        <button class="btn btn-primary" @click="approvePlan()" :disabled="actionLoading">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                            Approve Plan
                                        </button>
                                    </template>
                                    <template x-if="planEditing">
                                        <button class="btn btn-primary" @click="savePlanEdits()" :disabled="actionLoading">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                            Save &amp; Approve
                                        </button>
                                    </template>
                                    <button class="btn btn-danger btn-icon-only" @click="cancelPlan()" :disabled="actionLoading" title="Cancel Plan">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="selectedTask?.status === 'planning'">
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-icon-only" @click="cancelTask()" :disabled="actionLoading" title="Cancel">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="['completed', 'failed', 'cancelled', 'timed_out', 'max_iterations'].includes(selectedTask?.status)">
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-icon-only" @click="rerunTask()" :disabled="actionLoading" title="Rerun">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                        </svg>
                                    </button>
                                    <button class="btn btn-danger btn-icon-only" @click="deleteTask()" :disabled="actionLoading" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <button class="btn btn-icon" @click="closeTaskDetail()" title="Close">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ============================================================
                     Schedule Detail Modal
                     ============================================================ -->
                <div class="modal-overlay" x-show="selectedSchedule" x-cloak @click.self="closeScheduleDetail()">
                    <div class="modal detail-modal" x-show="selectedSchedule">
                        <div class="modal-header">
                            <div class="detail-header-content">
                                <span class="task-status" :class="selectedSchedule?.isEnabled ? 'status-scheduled' : 'status-cancelled'" x-text="selectedSchedule?.isEnabled ? 'Scheduled' : 'Disabled'"></span>
                                <h2 x-text="selectedSchedule?.title"></h2>
                            </div>
                            <button class="btn btn-icon" @click="closeScheduleDetail()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body" x-show="selectedSchedule">
                            <!-- Task Description -->
                            <div class="detail-section">
                                <h4>Description</h4>
                                <p class="detail-description" x-text="selectedSchedule?.description"></p>
                            </div>

                            <!-- Schedule Info Grid -->
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Provider</span>
                                    <span class="detail-value" x-text="selectedSchedule?.providerName"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Model</span>
                                    <span class="detail-value" x-text="selectedSchedule?.modelId"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Type</span>
                                    <span class="detail-value" x-text="selectedSchedule?.scheduleType === 'recurring' ? 'Recurring' : 'One-time'"></span>
                                </div>
                                <template x-if="selectedSchedule?.recurrence">
                                    <div class="detail-item">
                                        <span class="detail-label">Schedule</span>
                                        <span class="detail-value" x-text="formatRecurrence(selectedSchedule)"></span>
                                    </div>
                                </template>
                                <template x-if="selectedSchedule?.nextRunAt">
                                    <div class="detail-item">
                                        <span class="detail-label">Next Run</span>
                                        <span class="detail-value" x-text="formatDateTime(selectedSchedule?.nextRunAt)"></span>
                                    </div>
                                </template>
                                <template x-if="selectedSchedule?.lastRunAt">
                                    <div class="detail-item">
                                        <span class="detail-label">Last Run</span>
                                        <span class="detail-value" x-text="formatDateTime(selectedSchedule?.lastRunAt)"></span>
                                    </div>
                                </template>
                                <div class="detail-item">
                                    <span class="detail-label">Created</span>
                                    <span class="detail-value" x-text="formatDateTime(selectedSchedule?.createdAt)"></span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" x-show="selectedSchedule">
                            <div class="action-buttons">
                                <button class="btn btn-primary" @click="runScheduleNow()" :disabled="actionLoading">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Run Now
                                </button>
                                <button class="btn btn-secondary" @click="toggleSchedule()" :disabled="actionLoading">
                                    <span x-text="selectedSchedule?.isEnabled ? 'Disable' : 'Enable'"></span>
                                </button>
                                <button class="btn btn-danger" @click="deleteSchedule()" :disabled="actionLoading">Delete</button>
                            </div>
                            <button class="btn btn-secondary" @click="closeScheduleDetail()">Close</button>
                        </div>
                    </div>
                </div>

                <!-- ============================================================
                     Pending Alert Popups (questions/permissions from running tasks)
                     ============================================================ -->
                <template x-if="pendingAlerts.length > 0 && !selectedTask">
                    <div class="alert-popup-container">
                        <template x-for="alert in pendingAlerts" :key="alert.id">
                            <div class="alert-popup" :class="'alert-popup-' + alert.type">
                                <div class="alert-popup-header">
                                    <div class="alert-popup-title">
                                        <!-- Question icon -->
                                        <template x-if="alert.type === 'question'">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                            </svg>
                                        </template>
                                        <!-- Permission icon -->
                                        <template x-if="alert.type === 'permission'">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                            </svg>
                                        </template>
                                        <span class="alert-popup-label" x-text="alert.type === 'question' ? 'Agent Question' : 'Permission Required'"></span>
                                    </div>
                                    <div class="alert-popup-task-name" x-text="alert.task.title"></div>
                                    <button class="btn btn-icon alert-popup-dismiss" @click="dismissAlert(alert)" title="Dismiss">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Question content -->
                                <template x-if="alert.type === 'question'">
                                    <div class="alert-popup-body">
                                        <p class="alert-popup-text" x-text="alert.task.pendingQuestion.question"></p>
                                        <template x-if="alert.task.pendingQuestion.suggestedAnswers?.length > 0">
                                            <div class="alert-popup-suggestions">
                                                <template x-for="(suggestion, i) in alert.task.pendingQuestion.suggestedAnswers" :key="i">
                                                    <button class="btn btn-secondary btn-small" @click="submitAlertAnswer(alert, suggestion)" :disabled="actionLoading" x-text="suggestion"></button>
                                                </template>
                                            </div>
                                        </template>
                                        <div class="alert-popup-input">
                                            <input type="text" class="action-bar-input" x-model="pendingAlertAnswer" placeholder="Type your answer..." @keydown.enter="submitAlertAnswer(alert)" :disabled="actionLoading">
                                            <button class="btn btn-primary btn-icon-only" @click="submitAlertAnswer(alert)" :disabled="actionLoading || !pendingAlertAnswer.trim()" title="Send">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </template>

                                <!-- Permission content -->
                                <template x-if="alert.type === 'permission'">
                                    <div class="alert-popup-body">
                                        <p class="alert-popup-tool" x-text="alert.task.pendingPermission.toolName"></p>
                                        <p class="alert-popup-text" x-text="alert.task.pendingPermission.details"></p>
                                        <div class="alert-popup-actions">
                                            <button class="btn btn-primary" @click="respondAlertPermission(alert, true)" :disabled="actionLoading">Approve</button>
                                            <button class="btn btn-danger" @click="respondAlertPermission(alert, false)" :disabled="actionLoading">Deny</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- ============================================================
                     Toast Notifications
                     ============================================================ -->
                <div class="toast-container">
                    <template x-for="toast in toasts" :key="toast.id">
                        <div class="toast" :class="'toast-' + toast.type" x-show="toast.visible" x-transition>
                            <span x-text="toast.message"></span>
                            <button class="toast-close" @click="removeToast(toast.id)">&times;</button>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>
</body>
</html>
